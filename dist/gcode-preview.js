!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three"),require("three-orbitcontrols")):"function"==typeof define&&define.amd?define(["exports","three","three-orbitcontrols"],t):t((e=e||self).GCodePreview={},e.THREE,e.THREE.OrbitControls)}(this,(function(e,t,s){"use strict";class i extends class{constructor(e,t){this.gcode=e,this.comment=t}}{constructor(e,t,s){super(e,s),this.params=t}}class r{constructor(e,t){this.layer=e,this.commands=t}}class n{parseCommand(e,t=!0){const s=e.trim().split(";"),r=s[0],n=t&&s[1]||null,a=r.split(/ +/g),o=a[0].toLowerCase();switch(o){case"g0":case"g1":const e=this.parseMove(a.slice(1));return new i(o,e,n);default:return null}}parseMove(e){return e.reduce((e,t)=>{const s=t.charAt(0).toLowerCase();return"x"!=s&&"y"!=s&&"z"!=s&&"e"!=s||(e[s]=parseFloat(t.slice(1))),e},{})}groupIntoLayers(e){const t=[];let s,n=0;for(const a of e.filter(e=>e instanceof i)){const e=a.params;e.z&&e.z>n&&(0!=n||e.z<2)?(n=e.z,s=new r(t.length,[a]),t.push(s)):s&&s.commands.push(a)}return t}parseGcode(e){console.time("parsing");const t=e.split("\n").filter(e=>e.length>0).map(e=>this.parseCommand(e)).filter(e=>null!==e),s=this.groupIntoLayers(t),i=s.length-1;return console.timeEnd("parsing"),{header:{slicer:"MySlicer"},layers:s,limit:i}}parseHeader(e){return{slicer:e.filter(e=>null!==e.comment).map(e=>e.comment).filter(e=>/(G|g)enerated/.test(e)).map(e=>e.includes("Slic3r")?"Slic3r":e.includes("Simplify3D")?"Simplify3D":e.includes("Cura_SteamEngine")?"Cura_SteamEngine":void 0)[0]}}}e.Colors={Cura_SteamEngine:{skirt:"lime","wall-inner":"purple","wall-outer":"blue",skin:"red",fill:"orange",support:"rgba(255,255,255,0.5)"},Simplify3D:{skirt:"lime","inner perimeter":"purple","outer perimeter":"blue",skin:"solid layer",fill:"infill",support:"rgba(255,255,255,0.5)"}},e.Preview=class{constructor(e){if(this.lineWidth=.6,this.parser=new n,this.limit=e.limit,this.scale=e.scale,e.lineWidth&&(this.lineWidth=e.lineWidth),this.rotation=void 0===e.rotation?0:e.rotation,this.rotationAnimation=e.rotationAnimation,this.zoneColors=e.zoneColors,e.canvas instanceof HTMLCanvasElement)this.canvas=e.canvas,this.ctx=this.canvas.getContext("2d");else{if(this.targetId=e.targetId,this.container=document.getElementById(this.targetId),!this.container)throw new Error("Unable to find element "+this.targetId);this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.container.appendChild(this.canvas),this.resize()}}clear(){this.ctx.clearRect(-this.canvas.width/2,-this.canvas.height/2,this.canvas.width,this.canvas.height)}resize(){this.canvas.width=this.canvas.parentNode.offsetWidth,this.canvas.height=this.canvas.offsetHeight}renderWithColor(e,t,s){if(s)this.ctx.strokeStyle=s;else{const e=Math.round(t/this.layers.length*80);this.ctx.strokeStyle="hsl(0, 0%, "+e+"%)"}this.ctx.beginPath();for(const t of e.commands)if("g0"==t.gcode){const e=t;this.ctx.moveTo(e.params.x,e.params.y)}else if("g1"==t.gcode){const e=t;e.params.e>0?this.ctx.lineTo(e.params.x,e.params.y):this.ctx.moveTo(e.params.x,e.params.y)}this.ctx.stroke()}drawLayer(e,t){if(e>t)return;const s=this.layers[e],i=this.projectIso({x:0,y:0},e);this.ctx.save(),this.ctx.scale(this.scale,this.scale),this.ctx.translate(i.x,i.y),this.ctx.rotate(this.rotation*Math.PI/180),this.ctx.translate(-this.center.x,-this.center.y),this.renderWithColor(s,e),this.ctx.restore()}render(){this.canvas.width=this.canvas.width,this.ctx.lineWidth=this.lineWidth,this.ctx.scale(1,-1),this.ctx.translate(this.canvas.width/2,-this.canvas.height/2),this.center=this.getAdjustedCenter();for(let e=0;e<this.layers.length;e++)this.drawLayer(e,this.limit)}processGCode(e){const{header:t,layers:s,limit:i}=this.parser.parseGcode(e);this.header=t,this.layers=s,this.limit=i,console.time("rendering"),this.render(),console.timeEnd("rendering")}animationLoop(){this.rotationAnimation&&(requestAnimationFrame(this.animationLoop.bind(this)),this.rotation+=2,this.rotation%=360,this.render())}startAnimation(){this.rotationAnimation=!0,this.animationLoop()}stopAnimation(){this.rotationAnimation=!1}getOuterBounds(e){const t=e||this.layers[0];let s=1/0,i=-1/0,r=1/0,n=-1/0;for(let e of t.commands){if("g91"==e.gcode)break;"g0"!=e.gcode&&"g1"!=e.gcode||(e.params.x<s&&(s=e.params.x),e.params.x>i&&(i=e.params.x),e.params.y<r&&(r=e.params.y),e.params.y>n&&(n=e.params.y))}return{minX:s,maxX:i,minY:r,maxY:n}}getCenter(e){const t=e||this.layers[0],s=this.getOuterBounds(t);return{x:s.minX+(s.maxX-s.minX)/2,y:s.minY+(s.maxY-s.minY)/2}}getAdjustedCenter(){const e=this.getCenter(this.layers[0]);return this.maxProjectionOffset=this.projectIso({x:0,y:0},this.layers.length-1),e.x+=this.maxProjectionOffset.x/2,e.y+=this.maxProjectionOffset.y/2,e}getSize(e){const t=e||this.layers[0],s=this.getOuterBounds(t);return{sizeX:s.maxX-s.minX,sizeY:s.maxY-s.minY}}drawBounds(e,t){this.ctx.strokeStyle=t;const{minX:s,maxX:i,minY:r,maxY:n}=this.getOuterBounds(e);console.log(s,r,i-s,n-r),this.ctx.strokeRect(s,r,i-s,n-r)}autoscale(){const{sizeX:e,sizeY:t}=this.getSize(),{width:s,height:i}=this.canvas;var r;return r=e/t>s/i?s/e:i/t,r*=.2}projectIso(e,t){return{x:e.x,y:e.y+.1*t}}},e.WebGLPreview=class{constructor(e){if(this.parser=new n,this.backgroundColor=14737632,this.travelColor=10027008,this.extrusionColor=65280,this.renderExtrusion=!0,this.renderTravel=!1,this.limit=e.limit,this.scene=new t.Scene,this.scene.background=new t.Color(this.backgroundColor),this.targetId=e.targetId,this.container=document.getElementById(this.targetId),!this.container)throw new Error("Unable to find element "+this.targetId);this.camera=new t.PerspectiveCamera(75,this.container.offsetWidth/this.container.offsetHeight,.1,1e3),this.camera.position.set(0,0,50),this.renderer=new t.WebGLRenderer({preserveDrawingBuffer:!0}),this.renderer.setSize(this.container.offsetWidth,this.container.offsetHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.canvas=this.renderer.domElement,this.container.appendChild(this.canvas);new s(this.camera,this.renderer.domElement);this.animate()}animate(){requestAnimationFrame(()=>this.animate()),this.renderer.render(this.scene,this.camera)}processGCode(e){const{header:t,layers:s,limit:i}=this.parser.parseGcode(e);this.header=t,this.layers=s,this.limit=i,console.time("rendering webgl"),this.render(),console.timeEnd("rendering webgl")}render(){for(;this.scene.children.length>0;)this.scene.remove(this.scene.children[0]);this.group=new t.Group,this.group.name="gcode";const e={x:0,y:0,z:0,e:0};for(let s=0;s<this.layers.length&&!(s>this.limit);s++){const i={extrusion:[],travel:[],z:e.z},r=this.layers[s];for(const t of r.commands)if("g0"==t.gcode||"g1"==t.gcode){const s=t,r={x:void 0!==s.params.x?s.params.x:e.x,y:void 0!==s.params.y?s.params.y:e.y,z:void 0!==s.params.z?s.params.z:e.z,e:void 0!==s.params.e?s.params.e:e.e},n=s.params.e>0;this.addLineSegment(i,e,r,n),s.params.x&&(e.x=s.params.x),s.params.y&&(e.y=s.params.y),s.params.z&&(e.z=s.params.z),s.params.e&&(e.e=s.params.e)}const n=Math.round(80*s/this.layers.length),a=new t.Color(`hsl(0, 0%, ${n}%)`).getHex();this.renderExtrusion&&this.addLine(i.extrusion,a),this.renderTravel&&this.addLine(i.travel,this.travelColor)}this.group.quaternion.setFromEuler(new t.Euler(-Math.PI/2,0,0)),this.group.position.set(-100,-20,100),this.scene.add(this.group),this.renderer.render(this.scene,this.camera)}resize(){this.renderer.setSize(this.container.offsetWidth,this.container.offsetHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.camera.aspect=this.container.offsetWidth/this.container.offsetHeight,this.camera.updateProjectionMatrix()}addLineSegment(e,t,s,i){const r=i?e.extrusion:e.travel;r.push(t.x,t.y,t.z),r.push(s.x,s.y,s.z)}addLine(e,s){const i=new t.BufferGeometry;i.setAttribute("position",new t.Float32BufferAttribute(e,3));const r=new t.LineBasicMaterial({color:s}),n=new t.LineSegments(i,r);this.group.add(n)}},Object.defineProperty(e,"__esModule",{value:!0})}));
